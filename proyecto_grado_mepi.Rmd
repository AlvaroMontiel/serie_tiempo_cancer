---
title: "Serie de tiempo, cancer de pulmon, piel y vejiga en Antofagasta"
output:
  html_document:
    df_print: paged
    pdf_document: default
    css: ["style-1.css", "style-2.css"]
---

```{r, carga de archivos, echo=FALSE, include=FALSE}
library(readr)
if (Sys.info()[['sysname']] == "Darwin"){
  bd <- read_delim("/Users/alvaro/Documents/Data_Science/R/proyecto_grado/cr5_18052022.txt", 
    delim = "\t", escape_double = FALSE, 
    trim_ws = TRUE)
} else {
   bd <- read_delim("C:/Users/Usuario/Documents/R/proyecto de grado/cr5_18052022.txt", 
    delim = "\t", escape_double = FALSE, 
    trim_ws = TRUE) 
}

```

Variables en la base de datos.

-   TUMOURID: Identificación del tumor.

-   NOCASO: Número del caso (1 caso puede tener uno o más tumores).

-   FECNAC: Fecha nacimiento en formato YYYYMMDD (variable numérica).

-   EDAD: Edad en años a la fecha del diagnóstico.

-   SEXO:

    -   1=Hombre,

    -   2=Mujeres.

-   REGCOM: Código comunas:

    -   2101=Antofagasta;

    -   2201=Calama;

    -   2301=Tocopilla.

-   FECDIAG: Fecha de diagnóstico del tumor en formato YYYYMMDD (variable numérica), "20030101 - 20151231".

-   TOP: Código topográfico del tumor en formato CIE-O.

-   MORF: Código morfológico CIE-O.

-   MORF_GRUPO (PULMON):

    -   1=Neoplasias, SAI;

    -   2=Neoplasias Epiteliales, SAI;

    -   3=Neoplasias de Células escamosas;

    -   4=Adenocarcinomas;

    -   5=Otras Morfologías

-   COMP: Comportamiento del tumor:

    -   3=Maligno.

-   GRA: Grado de diferenciación del tumor:

    -   1=Bien diferenciado;

    -   2= Moderadamente Diferenciado;

    -   3=Poco Diferenciado;

    -   4=Anaplásico;

    -   5=Células T;

    -   6=Células B;

    -   7=Célula Nula;

    -   8=Células NK;

    -   9=Desconocido.

-   EXT: Grado de extensión del tumor:

    -   0=In situ;

    -   1=Localizado;

    -   2=Regional;

    -   3=Metástasis;

    -   9=Desconocido.

-   BASE: Base diagnóstico:

    -   0=Solo Certificado de defunción;

    -   1=Clínico;

    -   2=Investigación clínica;

    -   4=Bioquímica o Inmunología;

    -   5=Citología;

    -   6=Histología de metástasis;

    -   7=Histología de sitio primario;

    -   9=Desconocido.

-   C10: Código CIE10.

-   PMSEC: Secuencia de tumores primarios.

-   PMTOT: Número total de tumores primarios.

-   FUE1: Fuente.

-   RUT: Rut del caso.

```{r, Recorte de las variables, echo=FALSE, include=FALSE}
## Carga del paquete dplyr
library(dplyr)

## Nuevos Dataframes; por tipo de tumor, comuna y comportamiento:

## PIEL
bd_piel <- bd %>% 
  filter(TOP==440 | TOP==441 | TOP==442 | TOP==443 | TOP==444 | TOP==445 | 
           TOP==446 | TOP==447 | TOP==448 | TOP==449) %>%
  #filter(REGCOM=="02101" | REGCOM=="02201" | REGCOM=="02301" & COMP==3) %>%
  select(TUMOURID, NOCASO, FECNAC, EDAD, SEXO, REGCOM, FECDIAG,
         TOP, MORF, COMP, GRA, EXT, LAT, BASE, C10, PMSEC, PMTOT, FUE1, RUT)

## VEJIGA
bd_vejiga <- bd %>% 
  filter(TOP==670 | TOP==671 | TOP==672 | TOP==673 | TOP==674 | TOP==675 | 
           TOP==676 | TOP==677 | TOP==678 | TOP==679) %>%
  #filter(REGCOM=="02101" | REGCOM=="02201" | REGCOM=="02301" & COMP==3) %>%
  select(TUMOURID, NOCASO, FECNAC, EDAD, SEXO, REGCOM, FECDIAG,
         TOP, MORF, COMP, GRA, EXT, LAT, BASE, C10, PMSEC, PMTOT, FUE1, RUT)

## PULMON
bd_pulmon <- bd %>% 
  filter(TOP==340 | TOP==341 | TOP==342 | TOP==343 | TOP==344 | TOP==345 | 
           TOP==346 | TOP==347 | TOP==348 | TOP==349) %>% 
  
  #filter(REGCOM=="02101" | REGCOM=="02201" | REGCOM=="02301" & COMP==3) %>%
  select(TUMOURID, NOCASO, FECNAC, EDAD, SEXO, REGCOM, FECDIAG,
         TOP, MORF, COMP, GRA, EXT, LAT, BASE, C10, PMSEC, PMTOT, FUE1, RUT)

```

```{r, Ajuste a la base de datos, echo=FALSE, include=FALSE }
## NUEVA VARIABLE PARA LA TOPOGRAFÍA DEL PULMON:  
### TODAS LAS SUBLOCALIZACIONES AGRUPADAS COMO C34, SON MUY POCAS LAS LOCALIZACIONES
### NO C349
bd_pulmon$TOP_ <- "C34"

## CORREGÍ UNA MORFOLOGÍA EN EL ORIGEN POR SER MUY RARA Y AL VOLVER A REVISAR LA BIOPSIA
## EL CÓDIGO 8323 ERA MÁS APROPIADO.
bd_pulmon <- bd_pulmon %>% mutate(MORF = ifelse(RUT == 5302873, 8323, MORF))

## AGRUPACION DE LAS MORFOLOGIAS PARA BASE DE PULMÓN
bd_pulmon <- bd_pulmon %>% mutate(MORF_GRUPO = case_when(
  MORF == 8000 | MORF == 8001 | MORF == 8002 ~ 1,
  MORF == 8010 | MORF == 8012 | MORF == 8013 | MORF == 8021 | MORF == 8032 |
  MORF == 8033 | MORF == 8041 | MORF == 8042 | MORF == 8043 | MORF == 8044 |
  MORF == 8045 | MORF == 8046 ~ 2,
  MORF == 8050 | MORF == 8070 | MORF == 8071 | MORF == 8072 | MORF == 8073 | 
  MORF == 8075 | MORF == 8076 ~ 3,
  MORF == 8140 | MORF == 8211 | MORF == 8230 | MORF == 8240 | MORF == 8246 | 
  MORF == 8250 | MORF == 8252 | MORF == 8260 | MORF == 8263 | MORF == 8310 | 
  MORF == 8323 ~ 4,
  MORF == 8430 | MORF == 8480 | MORF == 8481 | MORF == 8490 | MORF == 8550 | 
  MORF == 8800 | MORF == 8990 | MORF == 9050 | MORF == 8090 ~ 5)
  )
```

# Estadística descriptiva

## Univariada categórica para tumores de Pulmón


```{r, descriptiva_categorica univariada}
## SEXO
table(factor(bd_pulmon$SEXO, levels=c(1,2), labels = c("Hombres", "Mujeres")))
round(prop.table(table(factor(bd_pulmon$SEXO, levels=c(1,2), labels = c("Hombres", "Mujeres"))))*100,2)


## REGIÓN
tabla_region = table(factor(bd_pulmon$REGCOM, levels=c("02101", "02102", "02103", "02104", 
                                        "02201", "02202", "02203",
                                        "02301", "02302"), 
      labels=c("Afta", "Mejillones", "Sierra Gorda", "Taltal", 
               "Calama", "Ollagüe", "San Pedro de Atacama", 
               "Tocopilla", "MAría Elena")))

addmargins(tabla_region)

round(prop.table(tabla_region),2)*100


## COMUNA
table(factor(bd_pulmon$REGCOM, levels=c("02101", "02201", "02301"), 
      labels=c("Afta", "Calama", "Tocopilla")))
round(prop.table(table(factor(bd_pulmon$REGCOM, levels=c("02101", "02201", "02301"), 
      labels=c("Afta", "Calama", "Tocopilla"))))*100,2)

## MORFOLOGÍA
table(factor(bd_pulmon$MORF_GRUPO, levels = c(1,2,3,4,5), labels = c(
  "Neoplasias, SAI", "Neoplasias Epiteliales, SAI", "Neoplasias de células escamosas", "Adenocarcinomas", "Otras morfologías")))

round(
  prop.table(
    table(
    factor(
      bd_pulmon$MORF_GRUPO, levels = c(1,2,3,4,5), labels = c(
        "Neoplasias, SAI", "Neoplasias Epiteliales, SAI", 
        "Neoplasias de células escamosas", "Adenocarcinomas", 
        "Otras morfologías"))))*100,2)

## GRADO DE DIFERENCIACIÓN
table(factor(bd_pulmon$GRA, levels = c(1,2,3,4,9), labels = 
               c("Bien Diferenciado","Moderadamente Diferenciados",
                 "Poco Diferenciado","Anaplásico","Desconocido")))

round(prop.table(table(factor(
 bd_pulmon$GRA, levels = c(1,2,3,4,9), labels = 
               c("Bien Diferenciado","Moderadamente Diferenciados",
                 "Poco Diferenciado","Anaplásico","Desconocido") 
  )))*100,2)

## EXTENSIÓN
table(factor(bd_pulmon$EXT, levels = c(1,2,3,9), labels = c(
  "Localizado","Regional","Metástasis","Desconocido"
)))
round(prop.table(table(factor(bd_pulmon$EXT, levels = c(1,2,3,9),
                              labels=c(                                "Localizado","Regional","Metástasis","Desconocido"  
                              )
                              )))*100,2)


## BASE DIAGNÓSTICO
table(factor(bd_pulmon$BASE, levels = c(0,1,2,5,6,7),
             labels = c("Solo DCO","Clínica","Investigación Clínica","Citología","Histología de MTS","Histología de sitio primario")
             ))
round(prop.table(table(factor(bd_pulmon$BASE, levels = c(0,1,2,
                                                         5,6,7), 
                              labels = c(
                                "Solo DCO","Clínica","Investigación Clínica","Citología","Histología de MTS","Histología de sitio primario"
                              ))
                              ))*100,2)

## PRIMARIO MÚLTIPLES
### HAY 134 NA, TRATAR DE ARREGLAR EN LA BASE DE CR5
addmargins(table(bd_pulmon$PMTOT))

```

## Univariada cuantitativa, Pulmón

### EDAD

```{r, descriptiva_cuanti}
bd_pulmon %>% summarise(
  Mínimo = min(EDAD),
  Máximo = max(EDAD),
  Rango = max(EDAD)-min(EDAD),
  Qu_25 = quantile(EDAD, prob=c(0.25)),
  Qu_50 = quantile(EDAD, prob=c(0.5)),
  Qu_75 = quantile(EDAD, prob=c(0.75)),
  Media = round(mean(EDAD),4),
  Mediana = median(EDAD),
  Varianza = round(var(EDAD),4),
  Desv_Estándar = round(sd(EDAD),4),
  CV = round(sd(EDAD)/mean(EDAD)*100,4)
)
```

```{r, histograma_edad}
hist(bd_pulmon$EDAD)

plot(density(bd_pulmon$EDAD),
     lwd=3,
     col="blue3",
     xlim = c(15, 100),
     main="Gráfico de densidad de la Edad",
     las=1,
     xlab="Edad",
     ylab="densidad")
```

```{r, normal_qq_edad}
qqnorm(bd_pulmon$EDAD, pch=20, main="QQ Edad")
qqline(bd_pulmon$EDAD)

```

```{r, shapiro_test_edad}
# H0 = la muestra proviene de una población normal
shapiro.test(bd_pulmon$EDAD)

```


## Bivariada 


# Serie de tiempo

## ajuste de tasa anual








## Estadística descriptiva - Univariada serie de tiempo pulmón

```{r,Ajuste_FECDIAG_ (tipo DATE), echo=FALSE, include=FALSE }
## Fechas
library(tidyverse)
new_date <- ""
contador <- 1 
for(i in bd_pulmon$FECDIAG){
  new_date[[contador]] <- str_c(str_sub(i, 1, 4),"-",str_sub(i, -4,-3),"-",str_sub(i, -2, -1))
  contador <- contador +  1
}

new_date <- as.Date(new_date, "%Y-%m-%d")

bd_pulmon$FECDIAG_ <- new_date
```

```{r variables_to_plot, echo=FALSE, include=FALSE }
#Ajuste de la variable de conteo (agrupada por mes), análisis descriptivo de la variable número de casos por mes y confección de gráfico de número de nuevos casos en función del tiempo (sin ningún ajuste!!)

## Grafico numero de casos en el tiempo
bd_pulmon$YEAR <- str_sub(bd_pulmon$FECDIAG_, 1,4)
bd_pulmon$MONTH <- str_sub(bd_pulmon$FECDIAG_, 6,7)
a <- bd_pulmon %>% group_by(YEAR, MONTH) %>% tally()
time_serie <- ts(a[,3], start=2003, frequency=12 )
```

```{r, plot_casos_mes_1}
## Casos de cancer de pulmon 2003-2015

plot(time_serie, ylim=c(0,40),
     main="Número de casos, cáncer de pulmon mensuales 2003-2015")
```

```{r, plot_casos_mes_2, echo=FALSE, include=FALSE}
## Otra forma de obtener el grafico

library(lubridate)
contador = 1
new_date_2 =""
for(i in bd_pulmon$FECDIAG){
  new_date_2[[contador]] <- str_c(str_sub(i, 1, 4),"-",str_sub(i, -4,-3))
  contador <- contador +  1
}
bd_pulmon$MESAÑO <- new_date_2

by_mesdiag <- bd_pulmon %>% group_by(MESAÑO)
conteo_mes <- by_mesdiag %>% tally()

if (nrow(conteo_mes) < 156) {
  print("Hay meses sin nuevos casos")
} else (
  print("Todos los meses con casos")
)

casos_nuevos_mes <- ts(conteo_mes[,2], start=2003, frequency=12)
plot(casos_nuevos_mes, 
     ylim= c(0, 40))

#ggplot(data = conteo_mes, aes(x = as.Date(MESAÑO,"%Y-%m"), y = n)) 
#+ geom_line(color = "#00AFBB", size = 2)
```

```{r,descriptiva_casos_mes}
## Descriptive analysis of lung cancer cases by month 

conteo_mes %>% summarise(
  Mínimo = min(n),
  Máximo = max(n),
  Rango = max(n)-min(n),
  Qu_25 = quantile(n, prob=c(0.25)),
  Qu_50 = quantile(n, prob=c(0.5)),
  Qu_75 = quantile(n, prob=c(0.75)),
  Media = round(mean(n),4),
  Mediana = median(n),
  Varianza = round(var(n),4),
  Desv_Estándar = round(sd(n),4),
  CV = round(sd(n)/mean(n)*100,4)
)
```

```{r tasa_to_scaterplot, include=FALSE, echo=FALSE}
### Scaterplot 
### Computar tasas ajustadas, usé la población INE para cada año calendario
a <- a %>% mutate(population = case_when(
  YEAR == 2003 ~ 510045,
  YEAR == 2004 ~ 517333,
  YEAR == 2005 ~ 524422,
  YEAR == 2006 ~ 531553,
  YEAR == 2007 ~ 539071,
  YEAR == 2008 ~ 546939,
  YEAR == 2009 ~ 554646,
  YEAR == 2010 ~ 562331,
  YEAR == 2011 ~ 570307,
  YEAR == 2012 ~ 578137,
  YEAR == 2013 ~ 586685,
  YEAR == 2014 ~ 596155,
  YEAR == 2015 ~ 604877
))

a$rate <- with(a, n/population*10^5)

```

```{r}
#summary de la Data para confeccionar el scaterplot
summary(a)

## scaterplot - tasa mensual 2003-2015
plot(a$rate,type="n",ylim=c(00,6),xlab="Year", ylab="Rate x 100.000",
     bty="l",xaxt="n")
points(a$rate,cex=0.7)
axis(1,at=0:13*12,labels=F)
axis(1,at=0:12*12+6,tick=F,labels=2003:2015)
title("Pulmon 2003-2015")
```

```{r, include=F, echo=F}
#Poisson with the standardised population as an offset
modelo1 <- glm(n ~ offset(log(population)), family="poisson", a)
summary(modelo1)
summary(modelo1)$dispersion
#round(ci.lin(modelo1,Exp=T),3)

# create a new dataframe with 0.1 time units to improve the graph
datanew <- data.frame(stdpop=mean(a$population),
                      time= 1:600/10,month=rep(1:120/10,5))

# We generate predicted values based on the model in order to create a plot
pred1 <- predict(modelo1,type="response",a)

#This can then be plotted along with a scatter graph (see above)
plot(a$rate,type="n",ylim=c(00,6),xlab="Year", ylab="Rate x 100.000",
     bty="l",xaxt="n")
points(a$rate,cex=0.7)
axis(1,at=0:13*12,labels=F)
axis(1,at=0:12*12+6,tick=F,labels=2003:2015)
title("Pulmon 2003-2015")
lines((1:156),pred1,col=2)


```

```{r, include=F, echo=F}
edades <- split(bd_pulmon$EDAD, bd_pulmon$SEXO)
plot(density(edades$`1`),
     lwd=3,
     col="blue3",
     xlim = c(15, 100),
     main="por sexo",
     las=1,
     xlab="Edad",
     ylab="densidad")
lines(density(edades$`2`), lwd =3,
      col="deeppink")
legend('topleft', legend=c("H", "M"),
       lwd=3,
       col=c('blue', 'deeppink'), bty='n')



qqnorm(edades$`1`, pch=20, main="QQ edad hombres")
qqline(edades$`1`)


qqnorm(edades$`2`, pch=20, main="QQ edad mujeres")
qqline(edades$`2`)


shapiro.test(edades$`1`)
shapiro.test(edades$`2`)

```
